'use strict';

const assert = require('assert');
const V2UriLiteralEncoder = require('../../lib/utils/V2UriLiteralEncoder');
const EdmPrimitiveTypeKind = require('../../../lib/edm/EdmPrimitiveTypeKind');

describe(__filename, () => {

    describe('V2UriLiteralEncoder', () => {

        describe('.encode() positive cases', () => {
            const testdata = [
                // Binary
                {
                    value: Buffer.from('binarydata', 'utf-8'),
                    type: EdmPrimitiveTypeKind.Binary,
                    expected: "X'62696e61727964617461'"
                },
                {
                    value: Buffer.from([0x62, 0x75, 0x66, 0x66, 0x65, 0x72]),
                    type: EdmPrimitiveTypeKind.Binary,
                    expected: "X'627566666572'"
                },
                // Boolean
                {
                    value: true,
                    type: EdmPrimitiveTypeKind.Boolean,
                    expected: 'true'
                },
                {
                    value: false,
                    type: EdmPrimitiveTypeKind.Boolean,
                    expected: 'false'
                },
                // Byte
                {
                    value: 255,
                    type: EdmPrimitiveTypeKind.Byte,
                    expected: '255'
                },
                {
                    value: 123,
                    type: EdmPrimitiveTypeKind.Byte,
                    expected: '123'
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.Byte,
                    expected: '0'
                },
                // Decimal
                {
                    value: 1.79E+10,
                    type: EdmPrimitiveTypeKind.Decimal,
                    expected: '17900000000M'
                },
                {
                    value: '1.79E+10',
                    type: EdmPrimitiveTypeKind.Decimal,
                    expected: '17900000000M'
                },
                {
                    value: 17900000000,
                    type: EdmPrimitiveTypeKind.Decimal,
                    expected: '17900000000M'
                },
                {
                    value: 1.79,
                    type: EdmPrimitiveTypeKind.Decimal,
                    expected: '1.79M'
                },
                {
                    value: '1.79E+309',
                    type: EdmPrimitiveTypeKind.Decimal,
                    expected: '179000000000000000000000000000000000000000000000000000000000000000000000000' +
                    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000' +
                    '0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000' +
                    '00000000000000000000000000000000000000000000000000000M'
                },
                {
                    value: '5e-325',
                    type: EdmPrimitiveTypeKind.Decimal,
                    expected: '0.00000000000000000000000000000000000000000000000000000000000000000000000000' +
                    '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000' +
                    '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000' +
                    '0000000000000000000000000000000000000000000000000000000000000000005M'
                },
                // Double
                {
                    value: 123456.789,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: '123456.789D'
                },
                {
                    value: Number.MAX_SAFE_INTEGER,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: Number.MAX_SAFE_INTEGER + 'D'
                },
                {
                    value: Number.MAX_VALUE,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: Number.MAX_VALUE + 'D'
                },
                {
                    value: Number.MIN_VALUE,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: Number.MIN_VALUE + 'D'
                },
                {
                    value: -Number.MAX_VALUE,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: (-Number.MAX_VALUE) + 'D'
                },
                {
                    value: -Number.MIN_VALUE,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: (-Number.MIN_VALUE) + 'D'
                },
                {
                    value: Number.NaN,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: 'NaN'
                },
                {
                    value: Number.POSITIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: 'INF'
                },
                {
                    value: Number.NEGATIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: '-INF'
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.Double,
                    expected: '0D'
                },
                // Guid
                {
                    value: '1234abcd-56ef-dc90-7f8e-a1b2c3d4e5f6',
                    type: EdmPrimitiveTypeKind.Guid,
                    expected: "guid'1234abcd-56ef-dc90-7f8e-a1b2c3d4e5f6'"
                },
                {
                    value: '1234abcd-56ef-dc90-7f8e-a1b2c3d4e5f6',
                    type: EdmPrimitiveTypeKind.Guid,
                    expected: "guid'1234abcd-56ef-dc90-7f8e-a1b2c3d4e5f6'"
                },
                {
                    value: '1234ABCD-56EF-DC90-7F8E-A1B2C3D4E5F6',
                    type: EdmPrimitiveTypeKind.Guid,
                    expected: "guid'1234ABCD-56EF-DC90-7F8E-A1B2C3D4E5F6'"
                },
                {
                    value: '1234AbCd-56eF-Dc90-7f8E-a1B2c3D4e5F6',
                    type: EdmPrimitiveTypeKind.Guid,
                    expected: "guid'1234AbCd-56eF-Dc90-7f8E-a1B2c3D4e5F6'"
                },
                {
                    value: 'abcdefab-cdef-feba-cdba-fedcbaabcdcc',
                    type: EdmPrimitiveTypeKind.Guid,
                    expected: "guid'abcdefab-cdef-feba-cdba-fedcbaabcdcc'"
                },
                {
                    value: '12345678-4321-9876-1245-123456789012',
                    type: EdmPrimitiveTypeKind.Guid,
                    expected: "guid'12345678-4321-9876-1245-123456789012'"
                },
                // Int16
                {
                    value: -32768,
                    type: EdmPrimitiveTypeKind.Int16,
                    expected: '-32768'
                },
                {
                    value: 32767,
                    type: EdmPrimitiveTypeKind.Int16,
                    expected: '32767'
                },
                {
                    value: 12345,
                    type: EdmPrimitiveTypeKind.Int16,
                    expected: '12345'
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.Int16,
                    expected: '0'
                },
                // Int32
                {
                    value: -2147483648,
                    type: EdmPrimitiveTypeKind.Int32,
                    expected: '-2147483648'
                },
                {
                    value: 2147483647,
                    type: EdmPrimitiveTypeKind.Int32,
                    expected: '2147483647'
                },
                {
                    value: 1234567890,
                    type: EdmPrimitiveTypeKind.Int32,
                    expected: '1234567890'
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.Int32,
                    expected: '0'
                },
                // Int64
                {
                    value: Number.MAX_SAFE_INTEGER,
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: `${Number.MAX_SAFE_INTEGER}L`
                },
                {
                    value: Number.MIN_SAFE_INTEGER,
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: `${Number.MIN_SAFE_INTEGER}L`
                },
                {
                    value: '9007199254740991',
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: '9007199254740991L'
                },
                {
                    value: '9223372036854775807',
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: '9223372036854775807L'
                },
                {
                    value: '-9223372036854775808',
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: '-9223372036854775808L'
                },
                {
                    value: '123e+2',
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: '12300L'
                },
                {
                    value: '12300e-2',
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: '123L'
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.Int64,
                    expected: '0L'
                },
                // SByte
                {
                    value: -128,
                    type: EdmPrimitiveTypeKind.SByte,
                    expected: '-128'
                },
                {
                    value: 127,
                    type: EdmPrimitiveTypeKind.SByte,
                    expected: '127'
                },
                {
                    value: 123,
                    type: EdmPrimitiveTypeKind.SByte,
                    expected: '123'
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.SByte,
                    expected: '0'
                },
                // Single
                {
                    value: 123.456,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '123.456F'
                },
                {
                    value: 123456,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '123456F'
                },
                {
                    value: 3.4028234663852886E+38,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '3.4028234663852886e+38F'
                },
                {
                    value: 1.401298464324817E-45,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '1.401298464324817e-45F'
                },
                {
                    value: -3.4028234663852886E+38,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '-3.4028234663852886e+38F'
                },
                {
                    value: -1.401298464324817E-45,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '-1.401298464324817e-45F'
                },
                {
                    value: Number.NaN,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: 'NaN'
                },
                {
                    value: Number.POSITIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: 'INF'
                },
                {
                    value: Number.NEGATIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '-INF'
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.Single,
                    expected: '0F'
                },
                // String
                {
                    value: 'string',
                    type: EdmPrimitiveTypeKind.String,
                    expected: "'string'"
                },
                {
                    value: 'string with spaces',
                    type: EdmPrimitiveTypeKind.String,
                    expected: "'string%20with%20spaces'"
                },
                {
                    value: "str'ing",
                    type: EdmPrimitiveTypeKind.String,
                    expected: "'str''ing'"
                },
                {
                    value: 'str/ing',
                    type: EdmPrimitiveTypeKind.String,
                    expected: "'str%2Fing'"
                },
                // Date
                {
                    value: '2017-11-30',
                    type: EdmPrimitiveTypeKind.Date,
                    expected: "datetime'2017-11-30T00:00:00'"
                },
                {
                    value: '0001-12-31',
                    type: EdmPrimitiveTypeKind.Date,
                    expected: "datetime'0001-12-31T00:00:00'"
                },
                // DateTimeOffset
                {
                    value: '2017-11-30T13:24Z',
                    type: EdmPrimitiveTypeKind.DateTimeOffset,
                    expected: "datetimeoffset'2017-11-30T13:24Z'"
                },
                {
                    value: '2017-11-30T13:24:36Z',
                    type: EdmPrimitiveTypeKind.DateTimeOffset,
                    expected: "datetimeoffset'2017-11-30T13:24:36Z'"
                },
                {
                    value: '2017-11-30T13:24:36.123Z',
                    type: EdmPrimitiveTypeKind.DateTimeOffset,
                    expected: "datetimeoffset'2017-11-30T13:24:36.123Z'"
                },
                {
                    value: '2017-11-30T13:24:36+01:00',
                    type: EdmPrimitiveTypeKind.DateTimeOffset,
                    expected: "datetimeoffset'2017-11-30T13:24:36+01:00'"
                },
                {
                    value: '2017-11-30T13:24:36-01:00',
                    type: EdmPrimitiveTypeKind.DateTimeOffset,
                    expected: "datetimeoffset'2017-11-30T13:24:36-01:00'"
                },
                // TimeOfDay
                {
                    value: '23:59:59.00000',
                    type: EdmPrimitiveTypeKind.TimeOfDay,
                    expected: "time'PT23H59M59.00000S'"
                },
                {
                    value: '23:59:59',
                    type: EdmPrimitiveTypeKind.TimeOfDay,
                    expected: "time'PT23H59M59S'"
                },
                {
                    value: '23:59',
                    type: EdmPrimitiveTypeKind.TimeOfDay,
                    expected: "time'PT23H59M'"
                },
                // Duration
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'P1DT2H3M4.5S',
                    expected: 'P1DT2H3M4.5S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: '-P1DT2H3M4.5S',
                    expected: '-P1DT2H3M4.5S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT2H3M4.5S',
                    expected: 'PT2H3M4.5S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'P4DT3M4.5S',
                    expected: 'P4DT3M4.5S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT4.5S',
                    expected: 'PT4.5S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT0.5S',
                    expected: 'PT0.5S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'P1D',
                    expected: 'P1D'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT2H',
                    expected: 'PT2H'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT12M',
                    expected: 'PT12M'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT45S',
                    expected: 'PT45S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT45.6789S',
                    expected: 'PT45.6789S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'P0DT0H0M0.0S',
                    expected: 'P0DT0H0M0.0S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'P1DT2H',
                    expected: 'P1DT2H'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'P14DT1234M',
                    expected: 'P14DT1234M'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'P45DT678S',
                    expected: 'P45DT678S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT3H56S',
                    expected: 'PT3H56S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT45M56S',
                    expected: 'PT45M56S'
                },
                {
                    type: EdmPrimitiveTypeKind.Duration,
                    value: 'PT3H45M',
                    expected: 'PT3H45M'
                }
            ];

            const test = data => {
                it(`should encode "${data.value}" with kind "${data.type}" to literal "${data.expected}"`, () => {
                    const encoded = new V2UriLiteralEncoder().encode(data.value, data.type);
                    assert.strictEqual(encoded, data.expected);
                });
            };

            for (const data of testdata) {
                test(data);
            }
        });

        describe('.encode() negative cases', () => {
            const testdata = [
                // Binary
                {
                    value: 'binarydata',
                    type: EdmPrimitiveTypeKind.Binary
                },
                {
                    value: 1,
                    type: EdmPrimitiveTypeKind.Binary
                },
                {
                    value: true,
                    type: EdmPrimitiveTypeKind.Binary
                },
                {
                    value: null,
                    type: EdmPrimitiveTypeKind.Binary
                },
                // Boolean
                {
                    value: 1,
                    type: EdmPrimitiveTypeKind.Boolean
                },
                {
                    value: 0,
                    type: EdmPrimitiveTypeKind.Boolean
                },
                {
                    value: 'true',
                    type: EdmPrimitiveTypeKind.Boolean
                },
                {
                    value: 'false',
                    type: EdmPrimitiveTypeKind.Boolean
                },
                // Byte
                {
                    value: 256,
                    type: EdmPrimitiveTypeKind.Byte
                },
                {
                    value: -1,
                    type: EdmPrimitiveTypeKind.Byte
                },
                // Decimal
                {
                    value: Number.POSITIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Decimal
                },
                {
                    value: Number.NEGATIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Decimal
                },
                // Guid
                {
                    value: 'Not-a-guid',
                    type: EdmPrimitiveTypeKind.Guid
                },
                // Int16
                {
                    value: -32769,
                    type: EdmPrimitiveTypeKind.Int16
                },
                {
                    value: 32768,
                    type: EdmPrimitiveTypeKind.Int16
                },
                // Int32
                {
                    value: -2147483649,
                    type: EdmPrimitiveTypeKind.Int16
                },
                {
                    value: 2147483648,
                    type: EdmPrimitiveTypeKind.Int16
                },
                // Int64
                {
                    value: Number.POSITIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Int64
                },
                {
                    value: Number.NEGATIVE_INFINITY,
                    type: EdmPrimitiveTypeKind.Int64
                },
                // SByte
                {
                    value: -129,
                    type: EdmPrimitiveTypeKind.SByte
                },
                {
                    value: 128,
                    type: EdmPrimitiveTypeKind.SByte
                },
                // Single
                {
                    value: 3.4028234663852886E+39,
                    type: EdmPrimitiveTypeKind.Single
                },
                {
                    value: 1.401298464324817E-46,
                    type: EdmPrimitiveTypeKind.Single
                },
                {
                    value: -3.4028234663852886E+39,
                    type: EdmPrimitiveTypeKind.Single
                },
                {
                    value: -1.401298464324817E-46,
                    type: EdmPrimitiveTypeKind.Single
                },
                // String
                {
                    value: 1,
                    type: EdmPrimitiveTypeKind.String
                },
                {
                    value: true,
                    type: EdmPrimitiveTypeKind.String
                },
                {
                    value: null,
                    type: EdmPrimitiveTypeKind.String
                },
                // Date
                {
                    value: '2017-11-30T13:24:36.098Z',
                    type: EdmPrimitiveTypeKind.Date,
                },
                {
                    value: '2017-11-30T13:24:36',
                    type: EdmPrimitiveTypeKind.Date,
                },
                {
                    value: '/Date(1512000000000)/',
                    type: EdmPrimitiveTypeKind.Date,
                },
                // DateTimeOffset
                {
                    value: '2017-11-30T13:24:36.123',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                {
                    value: '2017-11-30T13:24:36',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                {
                    value: '2017-11-30T13:2',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                {
                    value: '2017-11-30T13',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                {
                    value: '2017-11-30T13:24:36.123+1',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                {
                    value: '2017-11-30T13:24:36.123-1',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                {
                    value: '2017-11-30T13:24:36.123+10:0',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                {
                    value: '2017-11-30T13:24:36.123-10:0',
                    type: EdmPrimitiveTypeKind.DateTimeOffset
                },
                // TimeOfDay
                {
                    value: '24:01',
                    type: EdmPrimitiveTypeKind.TimeOfDay
                },
                {
                    value: '23:59:59.',
                    type: EdmPrimitiveTypeKind.TimeOfDay
                },
                {
                    value: '23:59:5',
                    type: EdmPrimitiveTypeKind.TimeOfDay
                },
                {
                    value: '23:59:',
                    type: EdmPrimitiveTypeKind.TimeOfDay
                },
                {
                    value: '23:5',
                    type: EdmPrimitiveTypeKind.TimeOfDay
                },
                {
                    value: '23:',
                    type: EdmPrimitiveTypeKind.TimeOfDay
                },
                {
                    value: '23',
                    type: EdmPrimitiveTypeKind.TimeOfDay
                }
            ];

            const test = data => {
                it(`should fail to encode "${data.value}" with kind "${data.type}"`, () => {
                    assert.throws(() => {
                        new V2UriLiteralEncoder().encode(data.value, data.type);
                    });
                });
            };

            for (const data of testdata) {
                test(data);
            }
        });
    });
});
