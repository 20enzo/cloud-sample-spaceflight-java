<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>OkraJS MetadataConverter Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script> window.module = { exports: {} }</script>
    <script src="/client/lib/converter/MetadataConverter.js"></script>
    <script>

        class Element {
            constructor(element) { this._element = element }
            show(value) { this._element.style.display = value || 'block' };
            hide(value) { this._element.style.display = value || 'none' };
            getValue() { return this._element.value };
            setValue(value) { this._element.value = value; return this; };
            setInnerHtml(value) { this._element.innerHTML = value; return this; };
        }

        // localStorage.clear();
        let externalData = localStorage.getItem('externalData');

        if (externalData == null) {
            externalData = {};
            localStorage.setItem('externalData', JSON.stringify(externalData));
        } else {
            console.log('before: ', externalData);
            externalData = JSON.parse(externalData);
        }


        function getById(id) {
            return new Element(document.getElementById(id));
        }

        const logdata = [];

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        let urlParam = getParameterByName('url') || 'http://' + window.location.host + '/client/test/resources/full-edmx.xml';

        const request = (url, callback) => {
            const request = new XMLHttpRequest();
            request.onreadystatechange = (event) => {
                if (request.readyState === XMLHttpRequest.DONE && request.status === 200) {
                    let xml = request.responseXML;
                    if (request.responseXML == null) {
                        xml = new DOMParser().parseFromString(request.responseText, "application/xml");
                    }
                    return callback(null, xml);
                }

                if (request.readyState === XMLHttpRequest.DONE && request.status !== 200) {
                    callback(new Error('GET Request to "' + url + '" was not successfull - StatusCode was: ' + request.status));
                }

            }
            console.log(`Processing url '${url}'`);
            request.open('GET', url);
            request.send();
        }

        function convert(url, mainCallback = () => { console.log('Request done'); }) {

            getById('result').setValue('Requesting result...');

            if (url == null) {
                return mainCallback(new Error('target is null'));
            }

            if (!url.startsWith('http')) {
                url = 'http://' + window.location.host + url;
            }

            const converter = new MetadataConverter()
                .addConversion([
                    new MetadataConverter.Strategy((input, callback) => {
                        request(url, callback);
                    }),
                    MetadataConverter.createOdataV4MetadataXmlToOdataV4CsdlStrategy()
                        .setMetadataFactory((path, callback) => {
                            console.log('Requesting external metadata for ' + path);

                            let target = externalData[path];

                            console.log(`External entry for ${path} found: `, target != null);

                            if (target) {
                                return request(target, callback);
                            }

                            getById('type').setValue(path);

                            throw new Error(
                                `Current implementation does not support requesting external metadata for '${path}'`
                            )
                        })
                        .setXmlNodeFactory((element) => {
                            const node = {
                                elements: [],
                                name: element.nodeName,
                                attributes: {}
                            };
                            if (element.attributes) {
                                Array.from(element.attributes).forEach((attribute) => {
                                    node.attributes[attribute.nodeName] = attribute.nodeValue;
                                })
                            }
                            element.childNodes.forEach((childNode) => {
                                if (childNode.nodeName === '#text') {
                                    childNode.text = childNode.nodeValue;
                                }
                                node.elements.push(childNode);
                            });

                            return node;
                        }),
                ]);

            converter.execute(null, (error, result) => {
                mainCallback(error, result, url)
            });
        }

        const execute = (error, result, url) => {
            if (error) {
                console.log('ERROR (' + url + '): ', error);

                getById('result').setValue(error.stack);
            } else {
                console.log('SUCCESS (' + url + '): ', result);

                getById('result').setValue(JSON.stringify(result, null, 2));
            }

        }

        function addTypeTarget(type, target, id) {

            if (type && target) {
                externalData[type] = target;
                localStorage.setItem('externalData', JSON.stringify(externalData));
            }

            console.log(externalData);


            const select = [];
            Object.keys(externalData).forEach((key) => {
                const value = externalData[key];
                select.push([value, `${key} -> ${value}`]);
            })
            const selectStr = renderSelect(select);
            getById(id).setInnerHtml(selectStr);
        }

        function renderSelect(arr) {
            return ['<select>']
                .concat(arr.map((elem) => {
                    return `<option value="${elem[1]}">${elem[1]}</option>`
                }))
                .concat(['</select>']);
        }

    </script>

    <style>
        body {
            font-family: Arial;
            margin: 0;
            padding: 30px;
        }

        footer {
            position: relative;
            left: 0px;
            bottom: 0px;
            height: 30px;
            width: 100%;
            background: rgb(209, 209, 209);
            text-align: center;
            margin-top: 10px;
            padding: 5px;
            color: #ababab;
            font-size: 12px;
            vertical-align: middle;
        }

        #content {
            position: relative;
            top: 0;
            left: 0;
            height: 100%;
        }

        #result {
            position: relative;
            min-height: 50vh;
            width: 100%;
            margin-top: 10px;
        }

        .center {
            text-align: center;
        }

        .right {
            float: right;
        }
    </style>

</head>

<body>

    <header class="center">
        <h1>MetadataConverter</h1>
    </header>

    <section id="target">
        <input type="text" id="targetInput" style="width: 500px" value="/client/test/resources/full-edmx.xml">
        <button onclick="convert(getById('targetInput').getValue(), execute)" style="width: 100px">Convert</button>
    </section>

    <section id="content">

        <h3>Result:</h3>

        <section>
            <div style="display: inline">Missing type: </div>
            <input type="text" id="type" style="width: 500px">
            <br>
            <div style="display: inline">Type source:</div>
            <input type="text" id="typeTarget" style="width: 500px">
            <br><br>
            <button onclick="addTypeTarget(getById('type').getValue(), getById('typeTarget').getValue(),'types');getById('type').setValue('');getById('typeTarget').setValue('')"
                style="width: 100px">Add</button>
            <button onclick="localStorage.clear()" style="width: 100px">Clear</button>

            <span id="types"></span>
        </section>

        <textarea id="result"></textarea>

    </section>

    <footer>&copy by Okra OData Node.js JavaScript Library</footer>

</body>

<script>

    // loadUrl(urlParam, execute);
    addTypeTarget(null, null, 'types');
</script>

</html>