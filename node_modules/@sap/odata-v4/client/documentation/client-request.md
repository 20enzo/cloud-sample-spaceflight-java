# Using ClientRequest / ServerResponse

## ClientRequest

### Creating an edm json model

To use the odata client request you have to create an edm json model.
This can either be done manually by writting a json document `{ $Version: '...', ...}`
or by converting an existing Metadata document (xml) with our V4-MetadataConverter into the edm json model.

See [MetadataConverter documentation](./v4-metadata-converter.md) here


### Creating a ClientRequest


```js 
const edmJson = require('./model.json');
const ClientRequest = require('@sap/odata/client').ClientRequest;
const UriBuilder = require('@sap/odata/client').UriBuilder;
let data = dataInJSON;
 
// Create the URI via UriBuilder
const uriBuilder = new UriBuilder(edmJson);
uriBuilder.v2().entitySet('SalesOrder').key(5).navigate('Items').orderby('Amount');

// Create the ClientRequest
new ClientRequest({

    // [MANDATORY]
    // The service root url pointing to the odata service document
    serviceRootUrl: 'http://server:port/serviceRootPath/',

    // [MANDATORY]
    // The odata url. This must be an instance of UriBuilder.
    url: uriBuilder,

    // [OPTIONAL]
    // Provide the Accept-Header here. This property will be used to generate the
    // resulting Accept-Header automatically also in case of a '/$metadata' request.
    // This property is optional. The default will be 'application/json'
    Accept: 'application/json',

    // [OPTIONAL]
    // Provide the Content-Type-Header here. This property will be used to generate the
    // resulting Content-Type-Header automatically.
    // This property is optional. The default will be 'application/json'
    ContentType: 'application/json',

    // [OPTIONAL]
    // All properties provided in the headers property will be used 'as is'. 
    // If, for example, an Odata-Version-Header is set inside the headers property
    // the value will be used 'as is'. These values overrides all other options.
    // This property is optional.
    headers: {
        // These values are taken 'as is'. No changes/validation will be done.
        'Content-Type': 'application/json'
        Accept: 'application/json'
    },
});

```

## Serializer/Deserializer

Currently we do not support the registration of other serializers/deserializers.
The built in serializers/deserializers support the following requests:

- POST
    - /EntitySet
- GET
    - /$metadata
    - /EntitySet
    - /EntitySet(key)
    - /EntitySet(key)/PropertyComplex
    - /EntitySet(key)/PropertyPrimitive
    - /EntitySet(key)/PropertyPrimitive/$value
    - /EntitySet(key)?$expand=NavigationProperty
    - /EntitySet(key)?$select=Property&$expand=NavigationProperty
- PUT
    - /EntitySet(key)
    - /EntitySet(key)/PropertyPrimitive/$value
- PATCH
    - /EntitySet(key)
- DELETE
- HEAD
- OPTIONS

## Listen for an error

If an error occurs it will be emitted with the `error` event. An error occurs if
it is not possible to provide a valid response object. 
For example an error can be emitted if:
- Serialization fails
- Deserialization fails
- Server connection fails
- An invalid url was provided via UriBuilder instance

The error is currently a plain `Error` object. 
An response with a status code of i.e. 404 will not lead to an error because a valid response
object can be provided.

- @param error: `Error` 
    - Plain javascript error object

```js
new ClientRequest(...)
    .on('error', (error) =>{
        // handle the error
    })
```

## Execute a GET request

- @param response: `ServerResponse` 
    - The `ServerResponse`

- @event error: `Error` 
    - Emitted if server connection failed
    
```js
new ClientRequest(...)
    .on('response', (response) =>{
        // response is of type ServerResponse
    })
    .get()
```


## Execute a POST request

Currently only application/json is supported.

- @param response: `ServerResponse` 
    - The `ServerResponse`

- @event error: `Error` 
    - Emitted if server connection failed
    - Emitted if serialization of the payload fails

```js
const data = { any: 'data' };
new ClientRequest(...)
    .on('error', ()=> { ... })
    .on('response', (response) =>{
        // response is of type ServerResponse
    })
    .post(data)
```

## Execute a PATCH request

Currently only application/json is supported.

- @param response: `ServerResponse` 
    - The `ServerResponse`

- @event error: `Error` 
    - Emitted if server connection failed
    - Emitted if serialization of the payload fails


```js
const data = { any: 'data' };
new ClientRequest(...)
    .on('error', ()=> { ... })
    .on('response', (response) =>{
        // response is of type ServerResponse
    })
    .patch(data)
```



## Execute a PUT request


Currently only application/json is supported.

- @param response: `ServerResponse` 
    - The `ServerResponse`

- @event error: `Error` 
    - Emitted if server connection failed
    - Emitted if serialization of the payload fails


```js
const data = { any: 'data' };
new ClientRequest(...)
    .on('error', ()=> { ... })
    .on('response', (response) =>{
        // response is of type ServerResponse
    })
    .put(data)
```


## Execute a DELETE request

- @param response: `ServerResponse` 
    - The `ServerResponse`

- @event error: `Error` 
    - Emitted if server connection failed

```js
new ClientRequest(...)
    .on('error', ()=> { ... })
    .on('response', (response) =>{
        // response is of type ServerResponse
    })
    .delete()
```

## Execute a HEAD request

- @param response: `ServerResponse` 
    - The `ServerResponse`

- @event error: `Error` 
    - Emitted if server connection failed

```js
new ClientRequest(...)
    .on('error', ()=> { ... })
    .on('response', (response) =>{
        // response is of type ServerResponse
    })
    .head()
```

## Execute an OPTIONS request

- @param response: `ServerResponse`
    - The `ServerResponse`

- @event error: `Error` 
    - Emitted if server connection failed

```js
new ClientRequest(...)
    .on('error', ()=> { ... })
    .on('response', (response) =>{
        // response is of type ServerResponse
    })
    .options()
```


## ServerResponse

See also 
- [V2 Deserialization](./deserialization.md)
- [V2 Serialization](./serialization.md)

### Get the deserialized response payload


This method returns the deserialized response payload. 
The parsing of the response payload is done,
when this method is called. If there was no content in the response this method returns `null`. In case of a OData V2 request the parsed result divers from the raw response payload since the deserialized payload is V4 compliant.

- @returns `Object|String|Null`
    - The deserialized response payload

- @throws `Error`
    - Thrown if deserialization fails


```js
response.getBody();
```

### Get the raw response payload


This method returns the raw response payload. If there was no content in the response this method returns `null`

- @returns `String|Null`
    - The raw response payload

```js
response.getRawBody();
```


### Get a header

This method returns the corresponding header value or null if there is none.

- @param name : `String`
    - name of the header value in lower case format

- @returns `String|Null`
    - The corresponding header value

```js
response.getHeader('name')
```


### Get all headers

This method returns all headers as a key-value-pair

- @returns `Object`
    - All headers available as key-value-pairs

```js
response.getHeaders()
```


### Get status code


This method returns the http status code

- @returns `Number`
    - The http status code

```js
response.getStatusCode()
```

## Example

```js
const ClientRequest = require('@sap/odata-v4/client').ClientRequest;
const UriBuilder = require('@sap/odata-v4/client').UriBuilder;

const edmJson = {
    $Version: '4.0',
    $EntityContainer: 'test.Container',
    test: {
        AnyType: {
            $Kind: 'EntityType',
            AnyProperty: {
                $Nullable: false
            },
        },
        Container: {
            AnySet: {
                $Kind: 'EntitySet',
                $Type: 'test.AnyType'
            }
        }
    }
};

const clientConfig = {
    serviceRootUrl: 'https://server:port/service',
    url: new UriBuilder(edmJson).v2().entitySet('AnySet'),
    headers: {
        Authorization: 'Basic ZDAzNsjskdpKN3o0mcksMg=='
    }
};

new ClientRequest(config)
    .on('error', () => { 
        // handle error
    })
    .on('response', (response) => { 
        try {
            const body = response.getBody()
            const statusCode = response.getStatusCode();
            // handle response
        } catch {
            // handle deserialisation error
        }
    })
    .get()
```


