'use strict';

const ContentNegotiatorCommand = require('./ContentNegotiatorCommand');
const QueryOptions = require('../uri/UriInfo').QueryOptions;
const ContentTypes = require('../format/ContentTypeInfo').ContentTypes;
const RepresentationKinds = require('../format/RepresentationKind').Kinds;

/**
* The `next` callback to be called upon finish execution.
*
* @callback Next
* @param {?Error} error An error if there is one or null if not
*/

/**
 * Executes the content negotiation in case of debug mode.
 *
 * @extends ContentNegotiatorCommand
 */
class ContentNegotiatorDebugCommand extends ContentNegotiatorCommand {

    /**
     * Creates an instance of ContentNegotiatorDebugCommand.
     *
     * @param {Context} context The current odata context
     * @param {FormatManager} formatManager The current instance of format manager
     * @param {ResponseContentNegotiator} contentNegotiator The current instance of ResponseContentNegotiator
     */
    constructor(context, formatManager, contentNegotiator) {
        super(context, formatManager, contentNegotiator);
    }

    /**
     * Executes the content negotiation in debug mode.
     * The content negotiation creates a `ResponseContract` object
     * as a result with all necessary content negotiation information.
     * The contract object is attached to the odata context instance.
     *
     * @param {Next} next The next callback to be called on finish
     */
    execute(next) {
        const context = this.getContext();
        const logger = context.getLogger();

        const response = context.getResponse();

        if (response.isHeadersSent()) {
            logger.debug('Headers already sent');
            next();
        } else {
            const queryOptions = context.getRequest().getQueryOptions();
            let resultingContentType = null;

            if (queryOptions[QueryOptions.ODATA_DEBUG] === 'json') {
                resultingContentType = ContentTypes.JSON;
            }

            if (queryOptions[QueryOptions.ODATA_DEBUG] === 'html') {
                resultingContentType = ContentTypes.HTML;
            }

            const formatManager = super.getFormatManager();
            const contract = super.getNegotiator()
                .negotiateContentType(formatManager, RepresentationKinds.DEBUG, resultingContentType);

            response.setContract(contract);

            logger.debug('Debug response contract contentTypeInfo: ', contract.getContentTypeInfo());

            next();
        }
    }
}

module.exports = ContentNegotiatorDebugCommand;
